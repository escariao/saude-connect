<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Saúde Connect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">Saúde Connect</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Início</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="busca.html">Buscar Profissionais</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="admin.html">Painel Admin</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-link">Sair</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="py-5 bg-light">
        <div class="container">
            <h2 class="section-title text-center">Painel Administrativo</h2>
            
            <div id="auth-alert" class="alert alert-danger d-none">
                Você precisa estar autenticado como administrador para acessar esta página.
                <a href="login.html" class="alert-link">Faça login</a> para continuar.
            </div>
            
            <div id="admin-content" class="d-none">
                <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-controls="pending" aria-selected="true">
                            Profissionais Pendentes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab" aria-controls="activities" aria-selected="false">
                            Gerenciar Atividades
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="adminTabContent">
                    <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                        <div class="admin-container">
                            <h4 class="mb-4">Profissionais Aguardando Aprovação</h4>
                            <div id="pending-professionals-container">
                                <div class="text-center py-3">
                                    <p>Carregando profissionais pendentes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="activities" role="tabpanel" aria-labelledby="activities-tab">
                        <div class="admin-container">
                            <h4 class="mb-4">Gerenciar Atividades/Especialidades</h4>
                            
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">Adicionar Nova Atividade</h5>
                                            <form id="activity-form">
                                                <div class="mb-3">
                                                    <label for="activity-name" class="form-label">Nome da Atividade</label>
                                                    <input type="text" class="form-control" id="activity-name" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="activity-description" class="form-label">Descrição</label>
                                                    <textarea class="form-control" id="activity-description" rows="2"></textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="activity-category" class="form-label">Categoria</label>
                                                    <input type="text" class="form-control" id="activity-category">
                                                    <div class="form-text">Ex: Enfermagem, Fisioterapia, Psicologia</div>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Adicionar Atividade</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h5 class="mb-3">Atividades Existentes</h5>
                            <div id="activities-list-container">
                                <div class="text-center py-3">
                                    <p>Carregando atividades...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4 mb-md-0">
                    <h5>Saúde Connect</h5>
                    <p>Conectando profissionais de saúde e pacientes de forma simples, segura e eficiente.</p>
                </div>
                <div class="col-md-4 mb-4 mb-md-0">
                    <h5>Links Rápidos</h5>
                    <ul class="list-unstyled footer-links">
                        <li><a href="index.html">Início</a></li>
                        <li><a href="busca.html">Buscar Profissionais</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contato</h5>
                    <ul class="list-unstyled footer-links">
                        <li><a href="mailto:contato@saudeconnect.com">contato@saudeconnect.com</a></li>
                        <li><a href="tel:+551199999999">(11) 9999-9999</a></li>
                    </ul>
                </div>
            </div>
            <hr class="mt-4 mb-3">
            <div class="text-center">
                <p class="mb-0">&copy; 2025 Saúde Connect. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Modal para visualização de diploma -->
    <div class="modal fade" id="diplomaModal" tabindex="-1" aria-labelledby="diplomaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="diplomaModalLabel">Visualizar Diploma</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body text-center">
                    <iframe id="diploma-frame" src="" style="width: 100%; height: 500px;"></iframe>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para rejeição -->
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectModalLabel">Rejeitar Profissional</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="reject-form">
                        <input type="hidden" id="reject-prof-id">
                        <div class="mb-3">
                            <label for="reject-reason" class="form-label">Motivo da Rejeição</label>
                            <textarea class="form-control" id="reject-reason" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirm-reject">Confirmar Rejeição</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticação
            if (!window.api.isAuthenticated()) {
                document.getElementById('auth-alert').classList.remove('d-none');
                document.getElementById('admin-content').classList.add('d-none');
                return;
            }
            
            // Verificar se é administrador
            const userType = window.api.getUserType();
            if (userType !== 'admin') {
                document.getElementById('auth-alert').classList.remove('d-none');
                document.getElementById('auth-alert').innerHTML = 'Você não tem permissão para acessar esta página. <a href="index.html" class="alert-link">Voltar para a página inicial</a>.';
                document.getElementById('admin-content').classList.add('d-none');
                return;
            }
            
            // Mostrar conteúdo administrativo
            document.getElementById('auth-alert').classList.add('d-none');
            document.getElementById('admin-content').classList.remove('d-none');
            
            // Carregar profissionais pendentes
            loadPendingProfessionals();
            
            // Carregar atividades
            loadActivities();
            
            // Configurar logout
            document.getElementById('logout-link').addEventListener('click', function(e) {
                e.preventDefault();
                window.api.logout();
                window.location.href = 'index.html';
            });
            
            // Configurar formulário de atividade
            document.getElementById('activity-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addActivity();
            });
            
            // Configurar modal de rejeição
            document.getElementById('confirm-reject').addEventListener('click', function() {
                rejectProfessional();
            });
        });
        
        async function loadPendingProfessionals() {
            const container = document.getElementById('pending-professionals-container');
            
            try {
                const professionals = await window.api.getPendingProfessionals();
                
                if (professionals.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">Não há profissionais pendentes de aprovação no momento.</div>';
                    return;
                }
                
                let html = '';
                
                professionals.forEach(prof => {
                    // Obter atividades do profissional
                    const activities = prof.activities.map(act => 
                        `<span class="activity-badge">${act.activity_name}</span>`
                    ).join(' ');
                    
                    html += `
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">${prof.name}</h5>
                                <span class="status-badge status-pending">Pendente</span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Email:</strong> ${prof.email}</p>
                                        <p><strong>Telefone:</strong> ${prof.phone || 'Não informado'}</p>
                                        <p><strong>Documento:</strong> ${prof.document_number}</p>
                                        <p><strong>Data de cadastro:</strong> ${prof.created_at}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Biografia:</strong> ${prof.bio || 'Não informada'}</p>
                                        <p><strong>Especialidades:</strong><br>${activities}</p>
                                        <p>
                                            <strong>Diploma:</strong> 
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewDiploma(${prof.id})">
                                                Visualizar Diploma
                                            </button>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer d-flex justify-content-end">
                                <button class="btn btn-danger me-2" onclick="openRejectModal(${prof.id})">Rejeitar</button>
                                <button class="btn btn-success" onclick="approveProfessional(${prof.id})">Aprovar</button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        Erro ao carregar profissionais pendentes: ${error.message || 'Tente novamente mais tarde.'}
                    </div>
                `;
            }
        }
        
        async function loadActivities() {
            const container = document.getElementById('activities-list-container');
            
            try {
                const activities = await window.api.getActivities();
                
                if (activities.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">Não há atividades cadastradas no momento.</div>';
                    return;
                }
                
                let html = '<div class="table-responsive"><table class="table table-striped">';
                html += `
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                activities.forEach(activity => {
                    html += `
                        <tr>
                            <td>${activity.id}</td>
                            <td>${activity.name}</td>
                            <td>${activity.description || '-'}</td>
                            <td>${activity.category || '-'}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        Erro ao carregar atividades: ${error.message || 'Tente novamente mais tarde.'}
                    </div>
                `;
            }
        }
        
        function viewDiploma(profId) {
            const diplomaFrame = document.getElementById('diploma-frame');
            diplomaFrame.src = `/api/admin/professionals/${profId}/diploma`;
            
            const diplomaModal = new bootstrap.Modal(document.getElementById('diplomaModal'));
            diplomaModal.show();
        }
        
        function openRejectModal(profId) {
            document.getElementById('reject-prof-id').value = profId;
            document.getElementById('reject-reason').value = '';
            
            const rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
            rejectModal.show();
        }
        
        async function rejectProfessional() {
            const profId = document.getElementById('reject-prof-id').value;
            const reason = document.getElementById('reject-reason').value;
            
            if (!reason) {
                alert('Por favor, informe o motivo da rejeição.');
                return;
            }
            
            try {
                await window.api.rejectProfessional(profId, reason);
                
                // Fechar modal
                const rejectModal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
                rejectModal.hide();
                
                // Recarregar lista
                loadPendingProfessionals();
                
                alert('Profissional rejeitado com sucesso!');
                
            } catch (error) {
                alert(`Erro ao rejeitar profissional: ${error.message || 'Tente novamente mais tarde.'}`);
            }
        }
        
        async function approveProfessional(profId) {
            if (!confirm('Tem certeza que deseja aprovar este profissional?')) {
                return;
            }
            
            try {
                await window.api.approveProfessional(profId);
                
                // Recarregar lista
                loadPendingProfessionals();
                
                alert('Profissional aprovado com sucesso!');
                
            } catch (error) {
                alert(`Erro ao aprovar profissional: ${error.message || 'Tente novamente mais tarde.'}`);
            }
        }
        
        async function addActivity() {
            const name = document.getElementById('activity-name').value;
            const description = document.getElementById('activity-description').value;
            const category = document.getElementById('activity-category').value;
            
            if (!name) {
                alert('Por favor, informe o nome da atividade.');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/activities`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.api.getAuthToken()}`
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        category
                    })
                });
                
                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Erro ao adicionar atividade');
                }
                
                // Limpar formulário
                document.getElementById('activity-name').value = '';
                document.getElementById('activity-description').value = '';
                document.getElementById('activity-category').value = '';
                
                // Recarregar lista
                loadActivities();
                
                alert('Atividade adicionada com sucesso!');
                
            } catch (error) {
                alert(`Erro ao adicionar atividade: ${error.message || 'Tente novamente mais tarde.'}`);
            }
        }
    </script>
</body>
</html>
